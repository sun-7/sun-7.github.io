<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content="Evernote Mac 7.8 (457454)"/><meta name="created" content="2019-03-12 03:04:49 +0000"/><meta name="source" content="maxiang"/><meta name="source-application" content="maxiang"/><meta name="updated" content="2019-03-13 03:11:26 +0000"/><title>安裝 Kubenetes</title></head><body lang="v2" style="color: #2c3f51; font-family: 'Helvetica Neue', Arial, 'Hiragino Sans GB', STHeiti, 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, Song, sans-serif; line-height: 1.6; background: none;"><del style="position:relative;display:block;z-index:10;"><a style="position: absolute;color: #FFF;text-decoration: none;font-size: 12px;height: 25px;border-radius: 0;margin-top: -20px;right: 15px;background: rgba(0, 0, 0, 0);border-left: 10px solid #BB3A34;border-right: 10px solid #BB3A34;border-bottom: 5px solid rgba(0, 0, 0, 0);width: 0;text-indent:-100000px;" href="http://marxi.co/#/?provider=evernote_int&amp;guid=8ddc00ac-2fdf-41b0-b134-783acfa6d5e6&amp;notebook=%E5%B7%A5%E4%BD%9C%E7%A2%8E%E7%89%87">Edit</a></del><div style="color: #2c3f51; font-family: 'Helvetica Neue', Arial, 'Hiragino Sans GB', STHeiti, 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, Song, sans-serif; line-height: 1.6;">
                        
                    



<h1 style="font-size: 41.6px; margin: 1.2em 0 .6em 0; font-family: inherit; font-weight: bold; line-height: 1.1; color: inherit; margin-top: 21px; margin-bottom: 10.5px; text-align: start;">安裝 Kubenetes</h1>

<h2 style="font-family: inherit; font-weight: bold; line-height: 1.1; color: inherit; margin-top: 21px; margin-bottom: 10.5px; font-size: 34.4px; margin: 1.2em 0 .6em 0; text-align: start;">安裝需求</h2>



<h3 style="font-family: inherit; font-weight: bold; color: inherit; margin-top: 21px; margin-bottom: 10.5px; font-size: 27.2px; margin: 1.2em 0 .6em 0; text-align: start; line-height: 1.6;">作業系統</h3>

<ul style="margin-top: 0; margin-bottom: 1.1em; padding-left: 2em; line-height: 1.6;"><li style="line-height: 1.6;"><p style="margin: 0; line-height: 1.6;">Ubuntu 16.04+</p></li>
<li style="line-height: 1.6;"><p style="margin: 0; line-height: 1.6;">Debian 9</p></li>
<li style="line-height: 1.6;"><p style="margin: 0; line-height: 1.6;">CentOS 7</p></li>
<li style="line-height: 1.6;"><p style="margin: 0; line-height: 1.6;">RHEL 7</p></li>
<li style="line-height: 1.6;"><p style="margin: 0; line-height: 1.6;">Fedora 25/26 (best-effort)</p></li>
<li style="line-height: 1.6;"><p style="margin: 0; line-height: 1.6;">HypriotOS v1.0.1+</p></li>
<li style="line-height: 1.6;"><p style="margin: 0; line-height: 1.6;">Container Linux (tested with 1800.6.0)</p></li>
</ul>



<h3 style="font-family: inherit; font-weight: bold; color: inherit; margin-top: 21px; margin-bottom: 10.5px; font-size: 27.2px; margin: 1.2em 0 .6em 0; text-align: start; line-height: 1.6;">規格</h3>

<ul style="margin-top: 0; margin-bottom: 1.1em; padding-left: 2em; line-height: 1.6;"><li style="line-height: 1.6;"><p style="margin: 0; line-height: 1.6;">2 core Up</p></li>
<li style="line-height: 1.6;"><p style="margin: 0; line-height: 1.6;">2G ram Up</p></li>
<li style="line-height: 1.6;"><p style="margin: 0; line-height: 1.6;">必須至少構成 LAN</p></li>
<li style="line-height: 1.6;"><p style="margin: 0; line-height: 1.6;">獨立 Hostname、Mac address、product_uuid</p></li>
<li style="line-height: 1.6;"><p style="margin: 0; line-height: 1.6;">Swap 必須關掉。成能保證 kubelet 運作正常。</p></li>
<li style="line-height: 1.6;"><p style="margin: 0; line-height: 1.6;">Port 需求</p>

<ul style="margin-top: 0; padding-left: 2em; margin-bottom: .55em; line-height: 1.6;">
<li style="line-height: 1.6;"><p style="margin: 0; line-height: 1.6;">Master </p>

<ul style="margin-top: 0; padding-left: 2em; margin-bottom: .55em; line-height: 1.6;">
<li style="line-height: 1.6;"><p style="margin: 0; line-height: 1.6;">TCP  Inbound 6443*   Kubernetes API server   All <br/>
TCP Inbound 2379-2380   etcd server client API  kube-apiserver, etcd <br/>
TCP Inbound 10250   Kubelet API Self, Control plane <br/>
TCP Inbound 10251   kube-scheduler  Self <br/>
TCP Inbound 10252   kube-controller-manager Self</p></li></ul></li>
<li style="line-height: 1.6;"><p style="margin: 0; line-height: 1.6;">Worker</p>

<ul style="margin-top: 0; padding-left: 2em; margin-bottom: .55em; line-height: 1.6;">
<li style="line-height: 1.6;"><p style="margin: 0; line-height: 1.6;">TCP   Inbound 10250   Kubelet API Self, Control plane <br/>
TCP Inbound 30000-32767 NodePort Services** All</p></li></ul></li></ul></li>
</ul>

<blockquote style="padding: 15px 20px; margin: 0 0 1.1em; border-left: 5px solid rgba(102,128,153,0.075); border-left-width: 10px; background-color: rgba(102,128,153,0.05); border-top-right-radius: 5px; border-bottom-right-radius: 5px;">
  <p style="margin: 0 0 1.1em; font-size: 1em; font-weight: 300; margin-bottom: 0; line-height: 1.6;">科普 CRI <br/>
  <a href="https://kubernetes.feisky.xyz/cha-jian-kuo-zhan/cri" target="_blank" style="background: transparent; color: #1980e6; text-decoration: none;">https://kubernetes.feisky.xyz/cha-jian-kuo-zhan/cri</a></p>
</blockquote>

<h3 style="font-family: inherit; font-weight: bold; color: inherit; margin-top: 21px; margin-bottom: 10.5px; font-size: 27.2px; margin: 1.2em 0 .6em 0; text-align: start; line-height: 1.6;">安裝 kubeadm, kubelet, and kubectl</h3>

<p style="margin: 0 0 1.1em; line-height: 1.6;">需要安裝下面套件到每台機器</p>

<ul style="margin-top: 0; margin-bottom: 1.1em; padding-left: 2em; line-height: 1.6;"><li style="line-height: 1.6;"><p style="margin: 0; line-height: 1.6;">kubeadm</p></li>
<li style="line-height: 1.6;"><p style="margin: 0; line-height: 1.6;">kubelet</p></li>
<li style="line-height: 1.6;"><p style="margin: 0; line-height: 1.6;">kubectl</p></li>
</ul>

<p style="margin: 0 0 1.1em; line-height: 1.6;">安裝方式：</p>



<pre style="font-family: 'Source Code Pro',Consolas,monospace; white-space: pre-wrap; display: block; background-color: rgba(102,128,153,0.05); color: #333; word-wrap: break-word; font-size: .9em; background: #f6f6f6; line-height: 1.6; margin: 0 0 1.1em; padding: 0; border: 0; border-radius: 5px; text-align: start; word-break: break-all;"><code style="font-family: 'Source Code Pro',Consolas,monospace; font-size: inherit; background-color: transparent; white-space: pre-wrap; border-radius: 0; color: #f8f8f2; display: block; overflow-x: auto; background: #23241f; padding: 1.3em 2em;"><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">[kubernetes]
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">name=Kubernetes
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">enabled=1
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">gpgcheck=1
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">repo_gpgcheck=1
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">exclude=kube*
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">EOF
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><div style="line-height: 1.6;"/>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><span style="display: inline; line-height: 1.6; color: #75715e; background-color: transparent;"># Set SELinux in permissive mode (effectively disabling it)</span>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">setenforce 0
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">sed -i <span style="display: inline; line-height: 1.6; color: #e6db74; background-color: transparent;">'s/^SELINUX=enforcing$/SELINUX=permissive/'</span> /etc/selinux/config
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><div style="line-height: 1.6;"/>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">yum install -y kubelet kubeadm kubectl --disableexcludes=kubernetes
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><div style="line-height: 1.6;"/>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">systemctl <span style="display: inline; line-height: 1.6; color: #e6db74; background-color: transparent;">enable</span> --now kubelet
</div></code></pre>

<blockquote style="padding: 15px 20px; margin: 0 0 1.1em; border-left: 5px solid rgba(102,128,153,0.075); border-left-width: 10px; background-color: rgba(102,128,153,0.05); border-top-right-radius: 5px; border-bottom-right-radius: 5px;">
  <ul style="margin-top: 0; padding-left: 2em; margin-bottom: 0; line-height: 1.6;"><li style="line-height: 1.6;"><p style="margin: 0; font-size: 1em; font-weight: 300; margin-bottom: 0; line-height: 1.6;">SELinux 停用是因為 container 需要讀取機器的檔案系統，這項設定必須做的直到 selinux 可以支援 kubelete</p></li>
  <li style="line-height: 1.6;"><p style="margin: 0; font-size: 1em; font-weight: 300; margin-bottom: 1.1em; line-height: 1.6;">在 RHEL 7 有遇到 routing 問題時，需要設定 IPTable bypass <br/>
  需要把 net.bridge.bridge-nf-call-iptables 設成 1</p>
  
  <pre style="font-family: 'Source Code Pro',Consolas,monospace; white-space: pre-wrap; display: block; background-color: rgba(102,128,153,0.05); color: #333; word-wrap: break-word; font-size: .9em; background: #f6f6f6; line-height: 1.6; margin: 0 0 1.1em; padding: 0; border: 0; border-radius: 5px; text-align: start; word-break: break-all;"><code style="font-family: 'Source Code Pro',Consolas,monospace; font-size: inherit; background-color: transparent; white-space: pre-wrap; border-radius: 0; color: #f8f8f2; display: block; overflow-x: auto; background: #23241f; padding: 1.3em 2em;"><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">cat &lt;&lt;EOF &gt;  /etc/sysctl.d/k8s.conf
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">net.bridge.bridge-nf-call-ip6tables = 1
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">net.bridge.bridge-nf-call-iptables = 1
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">EOF
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">sysctl --system
</div></code></pre>
  
  <blockquote style="padding: 15px 20px; margin: 0 0 1.1em; border-left: 5px solid rgba(102,128,153,0.075); border-left-width: 10px; background-color: rgba(102,128,153,0.05); border-top-right-radius: 5px; border-bottom-right-radius: 5px;">
    <ul style="margin-top: 0; padding-left: 2em; margin-bottom: 0; line-height: 1.6;">
    <li style="line-height: 1.6;"><p style="margin: 0; font-size: 1em; font-weight: 300; margin-bottom: 1.1em; line-height: 1.6;">需要查看 br_netfilter 有加載此步驟， <br/>
    可以使用 </p>
    
    <pre style="font-family: 'Source Code Pro',Consolas,monospace; white-space: pre-wrap; display: block; background-color: rgba(102,128,153,0.05); color: #333; word-wrap: break-word; font-size: .9em; background: #f6f6f6; line-height: 1.6; margin: 0 0 1.1em; padding: 0; border: 0; border-radius: 5px; text-align: start; word-break: break-all;"><code style="font-family: 'Source Code Pro',Consolas,monospace; font-size: inherit; background-color: transparent; white-space: pre-wrap; border-radius: 0; color: #f8f8f2; display: block; overflow-x: auto; background: #23241f; padding: 1.3em 2em;"><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><div style="line-height: 1.6;"/>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><span style="display: inline; line-height: 1.6; color: #75715e; background-color: transparent;"># 查看有沒有加載</span>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><div style="line-height: 1.6;"/>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">lsmod | grep br_netfilter
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><div style="line-height: 1.6;"/>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><span style="display: inline; line-height: 1.6; color: #75715e; background-color: transparent;"># 手動加載</span>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><div style="line-height: 1.6;"/>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">modprobe br_netfilter
</div></code></pre></li></ul>
  </blockquote></li>
  </ul>
</blockquote>



<h3 style="font-family: inherit; font-weight: bold; color: inherit; margin-top: 21px; margin-bottom: 10.5px; font-size: 27.2px; margin: 1.2em 0 .6em 0; text-align: start; line-height: 1.6;">使用 kubeadm</h3>

<h4 style="font-family: inherit; font-weight: bold; color: inherit; margin-top: 10.5px; margin-bottom: 10.5px; font-size: 20px; margin: 1.2em 0 .6em 0; text-align: start; line-height: 1.6;">建立 ClusterConfigure</h4>



<pre style="font-family: 'Source Code Pro',Consolas,monospace; white-space: pre-wrap; display: block; background-color: rgba(102,128,153,0.05); color: #333; word-wrap: break-word; font-size: .9em; background: #f6f6f6; line-height: 1.6; margin: 0 0 1.1em; padding: 0; border: 0; border-radius: 5px; text-align: start; word-break: break-all;"><code style="font-family: 'Source Code Pro',Consolas,monospace; font-size: inherit; background-color: transparent; white-space: pre-wrap; border-radius: 0; color: #f8f8f2; display: block; overflow-x: auto; background: #23241f; padding: 1.3em 2em;"><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><span style="display: inline; line-height: 1.6; color: #f92672; background-color: transparent;">apiVersion:</span> <span style="display: inline; line-height: 1.6; color: #e6db74; background-color: transparent;">kubeadm.k8s.io/v1beta1</span>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><span style="display: inline; line-height: 1.6; color: #f92672; background-color: transparent;">kind:</span> <span style="display: inline; line-height: 1.6; color: #e6db74; background-color: transparent;">ClusterConfiguration</span>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><span style="display: inline; line-height: 1.6; color: #f92672; background-color: transparent;">kubernetesVersion:</span> <span style="display: inline; line-height: 1.6; color: #e6db74; background-color: transparent;">stable</span>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><span style="display: inline; line-height: 1.6; color: #f92672; background-color: transparent;">apiServer:</span>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><span style="display: inline; line-height: 1.6; color: #f92672; background-color: transparent;">  certSANs:</span>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><span style="display: inline; line-height: 1.6; color: #ae81ff; background-color: transparent;">  -</span> <span style="display: inline; line-height: 1.6; color: #e6db74; background-color: transparent;">"{LB 的 IP, 如果沒有就用其中一個 master 只是不會實現 LB}"</span>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><span style="display: inline; line-height: 1.6; color: #f92672; background-color: transparent;">controlPlaneEndpoint:</span> <span style="display: inline; line-height: 1.6; color: #e6db74; background-color: transparent;">"{LB 的 IP}:6443"</span>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><span style="display: inline; line-height: 1.6; color: #f92672; background-color: transparent;">networking:</span>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><span style="display: inline; line-height: 1.6; color: #f92672; background-color: transparent;">  podSubnet:</span> <span style="display: inline; line-height: 1.6; color: #e6db74; background-color: transparent;">"10.244.0.0/16"</span>
</div></code></pre>



<h4 style="font-family: inherit; font-weight: bold; color: inherit; margin-top: 10.5px; margin-bottom: 10.5px; font-size: 20px; margin: 1.2em 0 .6em 0; text-align: start; line-height: 1.6;">kubeadm 安裝 kubernetes</h4>

<pre style="font-family: 'Source Code Pro',Consolas,monospace; white-space: pre-wrap; display: block; background-color: rgba(102,128,153,0.05); color: #333; word-wrap: break-word; font-size: .9em; background: #f6f6f6; line-height: 1.6; margin: 0 0 1.1em; padding: 0; border: 0; border-radius: 5px; text-align: start; word-break: break-all;"><code style="font-family: 'Source Code Pro',Consolas,monospace; font-size: inherit; background-color: transparent; white-space: pre-wrap; border-radius: 0; color: #f8f8f2; display: block; overflow-x: auto; background: #23241f; padding: 1.3em 2em;"><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><span style="display: inline; line-height: 1.6; color: #75715e; background-color: transparent;"># 建立出一個 Master</span>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">sudo kubeadm init --config=kubeadm-config.yaml
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><div style="line-height: 1.6;"/>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><span style="display: inline; line-height: 1.6; color: #75715e; background-color: transparent;"># 範例輸出：</span>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><span style="display: inline; line-height: 1.6; color: #75715e; background-color: transparent;"># To start using your cluster, you need to run the following as a regular user:</span>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><span style="display: inline; line-height: 1.6; color: #75715e; background-color: transparent;">#</span>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><span style="display: inline; line-height: 1.6; color: #75715e; background-color: transparent;">#   mkdir -p $HOME/.kube</span>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><span style="display: inline; line-height: 1.6; color: #75715e; background-color: transparent;">#   sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><span style="display: inline; line-height: 1.6; color: #75715e; background-color: transparent;">#   sudo chown $(id -u):$(id -g) $HOME/.kube/config</span>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><span style="display: inline; line-height: 1.6; color: #75715e; background-color: transparent;">#</span>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><span style="display: inline; line-height: 1.6; color: #75715e; background-color: transparent;"># You should now deploy a pod network to the cluster.</span>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><span style="display: inline; line-height: 1.6; color: #75715e; background-color: transparent;"># Run "kubectl apply -f [podnetwork].yaml" with one of the options listed at:</span>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><span style="display: inline; line-height: 1.6; color: #75715e; background-color: transparent;">#   https://kubernetes.io/docs/concepts/cluster-administration/addons/</span>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><span style="display: inline; line-height: 1.6; color: #75715e; background-color: transparent;">#</span>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><span style="display: inline; line-height: 1.6; color: #75715e; background-color: transparent;"># You can now join any number of machines by running the following on each node</span>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><span style="display: inline; line-height: 1.6; color: #75715e; background-color: transparent;"># as root:</span>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><span style="display: inline; line-height: 1.6; color: #75715e; background-color: transparent;">#</span>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><span style="display: inline; line-height: 1.6; color: #75715e; background-color: transparent;">#   kubeadm join {masterIP}:6443 --token d7fa07.i8ch5pfl2pldr624 --discovery-token-ca-cert-hash sha256:7860ad569cab30f4ea865a4b520c0a39cfe931815c23c498efa7fe40e0c75737 --experimental-control-plane</span>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><div style="line-height: 1.6;"/>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><span style="display: inline; line-height: 1.6; color: #75715e; background-color: transparent;"># 建立 kubectl configure</span>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">mkdir -p <span style="display: inline; line-height: 1.6; color: #f8f8f2; background-color: transparent;">$HOME</span>/.kube
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">sudo cp -i /etc/kubernetes/admin.conf <span style="display: inline; line-height: 1.6; color: #f8f8f2; background-color: transparent;">$HOME</span>/.kube/config
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">sudo chown $(id -u):$(id -g) <span style="display: inline; line-height: 1.6; color: #f8f8f2; background-color: transparent;">$HOME</span>/.kube/config
</div></code></pre>

<blockquote style="padding: 15px 20px; margin: 0 0 1.1em; border-left: 5px solid rgba(102,128,153,0.075); border-left-width: 10px; background-color: rgba(102,128,153,0.05); border-top-right-radius: 5px; border-bottom-right-radius: 5px;">
  <p style="margin: 0 0 1.1em; font-size: 1em; font-weight: 300; margin-bottom: 1.1em; line-height: 1.6;">前置作業：</p>
  
  <ol style="margin-top: 0; padding-left: 2em; margin-bottom: 0; line-height: 1.6;"><li style="line-height: 1.6;"><p style="margin: 0; font-size: 1em; font-weight: 300; margin-bottom: 0; line-height: 1.6;">關閉 swapoff -a </p></li>
  <li style="line-height: 1.6;"><p style="margin: 0; font-size: 1em; font-weight: 300; margin-bottom: 0; line-height: 1.6;">到 /etc/fstab 把 swap 磁區關閉</p></li>
  </ol>
</blockquote>

<h4 style="font-family: inherit; font-weight: bold; color: inherit; margin-top: 10.5px; margin-bottom: 10.5px; font-size: 20px; margin: 1.2em 0 .6em 0; text-align: start; line-height: 1.6;">轉發憑證</h4>

<ul style="margin-top: 0; margin-bottom: 1.1em; padding-left: 2em; line-height: 1.6;"><li style="line-height: 1.6;"><p style="margin: 0; line-height: 1.6;">如果你可以使用 master ssh 到其他機器 </p></li>
</ul>



<pre style="font-family: 'Source Code Pro',Consolas,monospace; white-space: pre-wrap; display: block; background-color: rgba(102,128,153,0.05); color: #333; word-wrap: break-word; font-size: .9em; background: #f6f6f6; line-height: 1.6; margin: 0 0 1.1em; padding: 0; border: 0; border-radius: 5px; text-align: start; word-break: break-all;"><code style="font-family: 'Source Code Pro',Consolas,monospace; font-size: inherit; background-color: transparent; white-space: pre-wrap; border-radius: 0; color: #f8f8f2; display: block; overflow-x: auto; background: #23241f; padding: 1.3em 2em;"><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><span style="display: inline; line-height: 1.6; color: #75715e; background-color: transparent;"># 先轉發憑證到被加入 master </span>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">USER=ubuntu <span style="display: inline; line-height: 1.6; color: #75715e; background-color: transparent;"># customizable</span>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">CONTROL_PLANE_IPS=<span style="display: inline; line-height: 1.6; color: #e6db74; background-color: transparent;">"10.0.0.7 10.0.0.8"</span>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><span style="display: inline; line-height: 1.6; color: #f92672; background-color: transparent;">for</span> host <span style="display: inline; line-height: 1.6; color: #f92672; background-color: transparent;">in</span> <span style="display: inline; line-height: 1.6; color: #f8f8f2; background-color: transparent;">${CONTROL_PLANE_IPS}</span>; <span style="display: inline; line-height: 1.6; color: #f92672; background-color: transparent;">do</span>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">    scp /etc/kubernetes/pki/ca.crt <span style="display: inline; line-height: 1.6; color: #e6db74; background-color: transparent;">"<span style="display: inline; line-height: 1.6; color: #f8f8f2; background-color: transparent;">${USER}</span>"</span>@<span style="display: inline; line-height: 1.6; color: #f8f8f2; background-color: transparent;">$host</span>:
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">    scp /etc/kubernetes/pki/ca.key <span style="display: inline; line-height: 1.6; color: #e6db74; background-color: transparent;">"<span style="display: inline; line-height: 1.6; color: #f8f8f2; background-color: transparent;">${USER}</span>"</span>@<span style="display: inline; line-height: 1.6; color: #f8f8f2; background-color: transparent;">$host</span>:
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">    scp /etc/kubernetes/pki/sa.key <span style="display: inline; line-height: 1.6; color: #e6db74; background-color: transparent;">"<span style="display: inline; line-height: 1.6; color: #f8f8f2; background-color: transparent;">${USER}</span>"</span>@<span style="display: inline; line-height: 1.6; color: #f8f8f2; background-color: transparent;">$host</span>:
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">    scp /etc/kubernetes/pki/sa.pub <span style="display: inline; line-height: 1.6; color: #e6db74; background-color: transparent;">"<span style="display: inline; line-height: 1.6; color: #f8f8f2; background-color: transparent;">${USER}</span>"</span>@<span style="display: inline; line-height: 1.6; color: #f8f8f2; background-color: transparent;">$host</span>:
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">    scp /etc/kubernetes/pki/front-proxy-ca.crt <span style="display: inline; line-height: 1.6; color: #e6db74; background-color: transparent;">"<span style="display: inline; line-height: 1.6; color: #f8f8f2; background-color: transparent;">${USER}</span>"</span>@<span style="display: inline; line-height: 1.6; color: #f8f8f2; background-color: transparent;">$host</span>:
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">    scp /etc/kubernetes/pki/front-proxy-ca.key <span style="display: inline; line-height: 1.6; color: #e6db74; background-color: transparent;">"<span style="display: inline; line-height: 1.6; color: #f8f8f2; background-color: transparent;">${USER}</span>"</span>@<span style="display: inline; line-height: 1.6; color: #f8f8f2; background-color: transparent;">$host</span>:
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">    scp /etc/kubernetes/pki/etcd/ca.crt <span style="display: inline; line-height: 1.6; color: #e6db74; background-color: transparent;">"<span style="display: inline; line-height: 1.6; color: #f8f8f2; background-color: transparent;">${USER}</span>"</span>@<span style="display: inline; line-height: 1.6; color: #f8f8f2; background-color: transparent;">$host</span>:etcd-ca.crt
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">    scp /etc/kubernetes/pki/etcd/ca.key <span style="display: inline; line-height: 1.6; color: #e6db74; background-color: transparent;">"<span style="display: inline; line-height: 1.6; color: #f8f8f2; background-color: transparent;">${USER}</span>"</span>@<span style="display: inline; line-height: 1.6; color: #f8f8f2; background-color: transparent;">$host</span>:etcd-ca.key
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">    scp /etc/kubernetes/admin.conf <span style="display: inline; line-height: 1.6; color: #e6db74; background-color: transparent;">"<span style="display: inline; line-height: 1.6; color: #f8f8f2; background-color: transparent;">${USER}</span>"</span>@<span style="display: inline; line-height: 1.6; color: #f8f8f2; background-color: transparent;">$host</span>:
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><span style="display: inline; line-height: 1.6; color: #f92672; background-color: transparent;">done</span>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><div style="line-height: 1.6;"/>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><span style="display: inline; line-height: 1.6; color: #75715e; background-color: transparent;"># 再將被加入 master 憑證歸位</span>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">    USER=ubuntu <span style="display: inline; line-height: 1.6; color: #75715e; background-color: transparent;"># customizable</span>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">    mkdir -p /etc/kubernetes/pki/etcd
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">    mv /home/<span style="display: inline; line-height: 1.6; color: #f8f8f2; background-color: transparent;">${USER}</span>/ca.crt /etc/kubernetes/pki/
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">    mv /home/<span style="display: inline; line-height: 1.6; color: #f8f8f2; background-color: transparent;">${USER}</span>/ca.key /etc/kubernetes/pki/
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">    mv /home/<span style="display: inline; line-height: 1.6; color: #f8f8f2; background-color: transparent;">${USER}</span>/sa.pub /etc/kubernetes/pki/
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">    mv /home/<span style="display: inline; line-height: 1.6; color: #f8f8f2; background-color: transparent;">${USER}</span>/sa.key /etc/kubernetes/pki/
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">    mv /home/<span style="display: inline; line-height: 1.6; color: #f8f8f2; background-color: transparent;">${USER}</span>/front-proxy-ca.crt /etc/kubernetes/pki/
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">    mv /home/<span style="display: inline; line-height: 1.6; color: #f8f8f2; background-color: transparent;">${USER}</span>/front-proxy-ca.key /etc/kubernetes/pki/
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">    mv /home/<span style="display: inline; line-height: 1.6; color: #f8f8f2; background-color: transparent;">${USER}</span>/etcd-ca.crt /etc/kubernetes/pki/etcd/ca.crt
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">    mv /home/<span style="display: inline; line-height: 1.6; color: #f8f8f2; background-color: transparent;">${USER}</span>/etcd-ca.key /etc/kubernetes/pki/etcd/ca.key
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">    mv /home/<span style="display: inline; line-height: 1.6; color: #f8f8f2; background-color: transparent;">${USER}</span>/admin.conf /etc/kubernetes/admin.conf
</div></code></pre>

<ul style="margin-top: 0; margin-bottom: 1.1em; padding-left: 2em; line-height: 1.6;"><li style="line-height: 1.6;"><p style="margin: 0; line-height: 1.6;">如果需要拖到跳板，再從跳板轉發 …！＠＄％！＃＄ㄓ</p></li>
</ul>

<pre style="font-family: 'Source Code Pro',Consolas,monospace; white-space: pre-wrap; display: block; background-color: rgba(102,128,153,0.05); color: #333; word-wrap: break-word; font-size: .9em; background: #f6f6f6; line-height: 1.6; margin: 0 0 1.1em; padding: 0; border: 0; border-radius: 5px; text-align: start; word-break: break-all;"><code style="font-family: 'Source Code Pro',Consolas,monospace; font-size: inherit; background-color: transparent; white-space: pre-wrap; border-radius: 0; color: #f8f8f2; display: block; overflow-x: auto; background: #23241f; padding: 1.3em 2em;"><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><span style="display: inline; line-height: 1.6; color: #75715e; background-color: transparent;"># 先從 master 機器到使用者家目錄</span>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">    cp /etc/kubernetes/pki/ca.crt cert/.
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">    cp /etc/kubernetes/pki/ca.key cert/.
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">    cp /etc/kubernetes/pki/sa.key cert/.
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">    cp /etc/kubernetes/pki/sa.pub cert/.
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">    cp /etc/kubernetes/pki/front-proxy-ca.crt cert/.
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">    cp /etc/kubernetes/pki/front-proxy-ca.key cert/.
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">    cp /etc/kubernetes/pki/etcd/ca.crt cert/etcd-ca.crt
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">    cp /etc/kubernetes/pki/etcd/ca.key cert/etcd-ca.key
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">    cp /etc/kubernetes/admin.conf cert/.
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><div style="line-height: 1.6;"/>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><span style="display: inline; line-height: 1.6; color: #75715e; background-color: transparent;"># 再從家目錄複製出來到跳板</span>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">    scp -r {account}@{host}:cert .
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><div style="line-height: 1.6;"/>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><span style="display: inline; line-height: 1.6; color: #75715e; background-color: transparent;"># 再從跳板轉發到其他需要加入 master 的機器</span>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">    scp -r cert {account}@{host}:
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><div style="line-height: 1.6;"/>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><span style="display: inline; line-height: 1.6; color: #75715e; background-color: transparent;"># 把被加入 master 機器的憑證歸位</span>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">    mkdir -p /etc/kubernetes/pki/etcd
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">    cp cert/ca.crt /etc/kubernetes/pki/ca.crt
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">    cp cert/ca.key /etc/kubernetes/pki/ca.key
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">    cp cert/sa.key /etc/kubernetes/pki/sa.key
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">    cp cert/sa.pub /etc/kubernetes/pki/sa.pub
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">    cp cert/front-proxy-ca.crt /etc/kubernetes/pki/front-proxy-ca.crt
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">    cp cert/front-proxy-ca.key /etc/kubernetes/pki/front-proxy-ca.key
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">    cp cert/etcd-ca.crt /etc/kubernetes/pki/etcd/ca.crt
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">    cp cert/etcd-ca.key /etc/kubernetes/pki/etcd/ca.key
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">    cp cert/admin.conf /etc/kubernetes/admin.conf
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><div style="line-height: 1.6;"/>
</div></code></pre>



<h4 style="font-family: inherit; font-weight: bold; color: inherit; margin-top: 10.5px; margin-bottom: 10.5px; font-size: 20px; margin: 1.2em 0 .6em 0; text-align: start; line-height: 1.6;">加入 master 指令</h4>



<pre style="font-family: 'Source Code Pro',Consolas,monospace; white-space: pre-wrap; display: block; background-color: rgba(102,128,153,0.05); color: #333; word-wrap: break-word; font-size: .9em; background: #f6f6f6; line-height: 1.6; margin: 0 0 1.1em; padding: 0; border: 0; border-radius: 5px; text-align: start; word-break: break-all;"><code style="font-family: 'Source Code Pro',Consolas,monospace; font-size: inherit; background-color: transparent; white-space: pre-wrap; border-radius: 0; color: #f8f8f2; display: block; overflow-x: auto; background: #23241f; padding: 1.3em 2em;"><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><span style="display: inline; line-height: 1.6; color: #75715e; background-color: transparent;"># 使用第一次安裝 kubeadm init 時，提示的 output</span>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><span style="display: inline; line-height: 1.6; color: #75715e; background-color: transparent;"># kubeadm join {masterIP}:6443 --token d7fa07.i8ch5pfl2pldr624 --discovery-token-ca-cert-hash sha256:7860ad569cab30f4ea865a4b520c0a39cfe931815c23c498efa7fe40e0c75737 --experimental-control-plane</span>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><div style="line-height: 1.6;"/>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><span style="display: inline; line-height: 1.6; color: #75715e; background-color: transparent;"># 是 master 就加入 --experimental-control-plane</span>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">kubeadm join {masterIP}:6443 --token d7fa07.i8ch5pfl2pldr624 --discovery-token-ca-cert-hash sha256:7860ad569cab30f4ea865a4b520c0a39cfe931815c23c498efa7fe40e0c75737 --experimental-control-plane
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><div style="line-height: 1.6;"/>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><span style="display: inline; line-height: 1.6; color: #75715e; background-color: transparent;"># 是 woker 只需要</span>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">kubeadm join {masterIP}:6443 --token d7fa07.i8ch5pfl2pldr624 --discovery-token-ca-cert-hash sha256:7860ad569cab30f4ea865a4b520c0a39cfe931815c23c498efa7fe40e0c75737
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><div style="line-height: 1.6;"/>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><span style="display: inline; line-height: 1.6; color: #75715e; background-color: transparent;"># 然後設定上 worker 標籤</span>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">kubectl label node {NODENAME} node-role.kubernetes.io/worker=worker
</div></code></pre>

<h4 style="font-family: inherit; font-weight: bold; color: inherit; margin-top: 10.5px; margin-bottom: 10.5px; font-size: 20px; margin: 1.2em 0 .6em 0; text-align: start; line-height: 1.6;">以 canal 為例:</h4>

<p style="margin: 0 0 1.1em; line-height: 1.6;">需要前置 –pod-network-cidr=10.244.0.0/16 和 amd64 的機器</p>



<pre style="font-family: 'Source Code Pro',Consolas,monospace; white-space: pre-wrap; display: block; background-color: rgba(102,128,153,0.05); color: #333; word-wrap: break-word; font-size: .9em; background: #f6f6f6; line-height: 1.6; margin: 0 0 1.1em; padding: 0; border: 0; border-radius: 5px; text-align: start; word-break: break-all;"><code style="font-family: 'Source Code Pro',Consolas,monospace; font-size: inherit; background-color: transparent; white-space: pre-wrap; border-radius: 0; color: #f8f8f2; display: block; overflow-x: auto; background: #23241f; padding: 1.3em 2em;"><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><div style="line-height: 1.6;"/>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><span style="display: inline; line-height: 1.6; color: #75715e; background-color: transparent;"># 安裝網路</span>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">kubectl apply <span style="display: inline; line-height: 1.6; background-color: transparent;">-f</span> https://docs.projectcalico.org/v3.3/getting-started/kubernetes/installation/hosted/canal/rbac.yaml
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">kubectl apply <span style="display: inline; line-height: 1.6; background-color: transparent;">-f</span> https://docs.projectcalico.org/v3.3/getting-started/kubernetes/installation/hosted/canal/canal.yaml
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><div style="line-height: 1.6;"/>
</div></code></pre>



<h1 style="font-size: 41.6px; margin: 1.2em 0 .6em 0; font-family: inherit; font-weight: bold; line-height: 1.1; color: inherit; margin-top: 21px; margin-bottom: 10.5px; text-align: start;">DONE.</h1>

<p style="margin: 0 0 1.1em; line-height: 1.6;">參考連結：</p>

<ul style="margin-top: 0; margin-bottom: 1.1em; padding-left: 2em; line-height: 1.6;"><li style="line-height: 1.6;"><p style="margin: 0; line-height: 1.6;"><a href="https://kubernetes.io/docs/setup/independent/create-cluster-kubeadm/" target="_blank" style="background: transparent; color: #1980e6; text-decoration: none;">Installing kubeadm</a></p></li>
<li style="line-height: 1.6;"><p style="margin: 0; line-height: 1.6;"><a href="https://kubernetes.io/docs/setup/independent/install-kubeadm/#check-required-ports" target="_blank" style="background: transparent; color: #1980e6; text-decoration: none;">Creating a single master cluster with kubeadm</a></p></li>
<li style="line-height: 1.6;"><p style="margin: 0; line-height: 1.6;"><a href="https://kubernetes.io/docs/setup/independent/high-availability/" target="_blank" style="background: transparent; color: #1980e6; text-decoration: none;">Creating Highly Available Clusters with kubeadm</a></p></li>
</ul></div><center style="display:none !important;visibility:collapse !important;height:0 !important;white-space:nowrap;width:100%;overflow:hidden">%23%20%u5B89%u88DD%20Kubenetes%0A%23%23%20%u5B89%u88DD%u9700%u6C42%0A%23%23%23%20%u4F5C%u696D%u7CFB%u7D71%0A*%20Ubuntu%2016.04+%0A*%20Debian%209%0A*%20CentOS%207%0A*%20RHEL%207%0A*%20Fedora%2025/26%20%28best-effort%29%0A*%20HypriotOS%20v1.0.1+%0A*%20Container%20Linux%20%28tested%20with%201800.6.0%29%0A%23%23%23%20%u898F%u683C%0A*%202%20core%20Up%0A*%202G%20ram%20Up%0A*%20%u5FC5%u9808%u81F3%u5C11%u69CB%u6210%20LAN%0A*%20%u7368%u7ACB%20Hostname%u3001Mac%20address%u3001product_uuid%0A*%20Swap%20%u5FC5%u9808%u95DC%u6389%u3002%u6210%u80FD%u4FDD%u8B49%20kubelet%20%u904B%u4F5C%u6B63%u5E38%u3002%0A*%20Port%20%u9700%u6C42%0A%0A%09*%20Master%20%0A%09%09*%20%20TCP%09Inbound%096443*%09Kubernetes%20API%20server%09All%0ATCP%09Inbound%092379-2380%09etcd%20server%20client%20API%09kube-apiserver%2C%20etcd%0ATCP%09Inbound%0910250%09Kubelet%20API%09Self%2C%20Control%20plane%0ATCP%09Inbound%0910251%09kube-scheduler%09Self%0ATCP%09Inbound%0910252%09kube-controller-manager%09Self%0A%09*%20Worker%0A%09%09*%20TCP%09Inbound%0910250%09Kubelet%20API%09Self%2C%20Control%20plane%0ATCP%09Inbound%0930000-32767%09NodePort%20Services**%09All%0A%0A%3E%20%u79D1%u666E%20CRI%0A%3E%20https%3A//kubernetes.feisky.xyz/cha-jian-kuo-zhan/cri%0A%0A%23%23%23%20%u5B89%u88DD%20kubeadm%2C%20kubelet%2C%20and%20kubectl%0A%u9700%u8981%u5B89%u88DD%u4E0B%u9762%u5957%u4EF6%u5230%u6BCF%u53F0%u6A5F%u5668%0A*%20kubeadm%0A*%20kubelet%0A*%20kubectl%0A%0A%u5B89%u88DD%u65B9%u5F0F%uFF1A%0A%60%60%60bash%0Acat%20%3C%3CEOF%20%3E%20/etc/yum.repos.d/kubernetes.repo%0A%5Bkubernetes%5D%0Aname%3DKubernetes%0Abaseurl%3Dhttps%3A//packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64%0Aenabled%3D1%0Agpgcheck%3D1%0Arepo_gpgcheck%3D1%0Agpgkey%3Dhttps%3A//packages.cloud.google.com/yum/doc/yum-key.gpg%20https%3A//packages.cloud.google.com/yum/doc/rpm-package-key.gpg%0Aexclude%3Dkube*%0AEOF%0A%0A%23%20Set%20SELinux%20in%20permissive%20mode%20%28effectively%20disabling%20it%29%0Asetenforce%200%0Ased%20-i%20%27s/%5ESELINUX%3Denforcing%24/SELINUX%3Dpermissive/%27%20/etc/selinux/config%0A%0Ayum%20install%20-y%20kubelet%20kubeadm%20kubectl%20--disableexcludes%3Dkubernetes%0A%0Asystemctl%20enable%20--now%20kubelet%0A%60%60%60%0A%3E%20*%20SELinux%20%u505C%u7528%u662F%u56E0%u70BA%20container%20%u9700%u8981%u8B80%u53D6%u6A5F%u5668%u7684%u6A94%u6848%u7CFB%u7D71%uFF0C%u9019%u9805%u8A2D%u5B9A%u5FC5%u9808%u505A%u7684%u76F4%u5230%20selinux%20%u53EF%u4EE5%u652F%u63F4%20kubelete%0A%3E%20*%20%u5728%20RHEL%207%20%u6709%u9047%u5230%20routing%20%u554F%u984C%u6642%uFF0C%u9700%u8981%u8A2D%u5B9A%20IPTable%20bypass%0A%3E%20%u9700%u8981%u628A%20net.bridge.bridge-nf-call-iptables%20%u8A2D%u6210%201%0A%3E%20%20%60%60%60%20bash%0A%3E%20%20cat%20%3C%3CEOF%20%3E%20%20/etc/sysctl.d/k8s.conf%0Anet.bridge.bridge-nf-call-ip6tables%20%3D%201%0Anet.bridge.bridge-nf-call-iptables%20%3D%201%0AEOF%0Asysctl%20--system%0A%3E%20%20%60%60%60%0A%3E%20%20%3E%20*%20%u9700%u8981%u67E5%u770B%20br_netfilter%20%u6709%u52A0%u8F09%u6B64%u6B65%u9A5F%uFF0C%0A%3E%20%20%3E%20%u53EF%u4EE5%u4F7F%u7528%20%0A%3E%20%20%3E%20%60%60%60bash%0A%3E%20%20%3E%20%23%20%u67E5%u770B%u6709%u6C92%u6709%u52A0%u8F09%0A%3E%20%20%3E%20lsmod%20%7C%20grep%20br_netfilter%0A%3E%20%20%3E%20%23%20%u624B%u52D5%u52A0%u8F09%0A%3E%20%20%3E%20modprobe%20br_netfilter%0A%3E%20%20%3E%20%60%60%60%0A%0A%23%23%23%20%u4F7F%u7528%20kubeadm%0A%23%23%23%23%20%u5EFA%u7ACB%20ClusterConfigure%0A%60%60%60yaml%0AapiVersion%3A%20kubeadm.k8s.io/v1beta1%0Akind%3A%20ClusterConfiguration%0AkubernetesVersion%3A%20stable%0AapiServer%3A%0A%20%20certSANs%3A%0A%20%20-%20%22%7BLB%20%u7684%20IP%2C%20%u5982%u679C%u6C92%u6709%u5C31%u7528%u5176%u4E2D%u4E00%u500B%20master%20%u53EA%u662F%u4E0D%u6703%u5BE6%u73FE%20LB%7D%22%0AcontrolPlaneEndpoint%3A%20%22%7BLB%20%u7684%20IP%7D%3A6443%22%0Anetworking%3A%0A%20%20podSubnet%3A%20%2210.244.0.0/16%22%0A%60%60%60%0A%0A%23%23%23%23%20kubeadm%20%u5B89%u88DD%20kubernetes%0A%60%60%60bash%0A%23%20%u5EFA%u7ACB%u51FA%u4E00%u500B%20Master%0Asudo%20kubeadm%20init%20--config%3Dkubeadm-config.yaml%0A%0A%23%20%u7BC4%u4F8B%u8F38%u51FA%uFF1A%0A%23%20To%20start%20using%20your%20cluster%2C%20you%20need%20to%20run%20the%20following%20as%20a%20regular%20user%3A%0A%23%0A%23%20%20%20mkdir%20-p%20%24HOME/.kube%0A%23%20%20%20sudo%20cp%20-i%20/etc/kubernetes/admin.conf%20%24HOME/.kube/config%0A%23%20%20%20sudo%20chown%20%24%28id%20-u%29%3A%24%28id%20-g%29%20%24HOME/.kube/config%0A%23%0A%23%20You%20should%20now%20deploy%20a%20pod%20network%20to%20the%20cluster.%0A%23%20Run%20%22kubectl%20apply%20-f%20%5Bpodnetwork%5D.yaml%22%20with%20one%20of%20the%20options%20listed%20at%3A%0A%23%20%20%20https%3A//kubernetes.io/docs/concepts/cluster-administration/addons/%0A%23%0A%23%20You%20can%20now%20join%20any%20number%20of%20machines%20by%20running%20the%20following%20on%20each%20node%0A%23%20as%20root%3A%0A%23%0A%23%20%20%20kubeadm%20join%20%7BmasterIP%7D%3A6443%20--token%20d7fa07.i8ch5pfl2pldr624%20--discovery-token-ca-cert-hash%20sha256%3A7860ad569cab30f4ea865a4b520c0a39cfe931815c23c498efa7fe40e0c75737%20--experimental-control-plane%0A%0A%23%20%u5EFA%u7ACB%20kubectl%20configure%0Amkdir%20-p%20%24HOME/.kube%0Asudo%20cp%20-i%20/etc/kubernetes/admin.conf%20%24HOME/.kube/config%0Asudo%20chown%20%24%28id%20-u%29%3A%24%28id%20-g%29%20%24HOME/.kube/config%0A%60%60%60%0A%0A%3E%20%u524D%u7F6E%u4F5C%u696D%uFF1A%0A%3E%201.%20%u95DC%u9589%20swapoff%20-a%20%0A%3E%202.%20%20%u5230%20/etc/fstab%20%u628A%20swap%20%u78C1%u5340%u95DC%u9589%0A%0A%23%23%23%23%20%u8F49%u767C%u6191%u8B49%0A*%20%u5982%u679C%u4F60%u53EF%u4EE5%u4F7F%u7528%20master%20ssh%20%u5230%u5176%u4ED6%u6A5F%u5668%20%0A%60%60%60bash%0A%23%20%u5148%u8F49%u767C%u6191%u8B49%u5230%u88AB%u52A0%u5165%20master%20%0AUSER%3Dubuntu%20%23%20customizable%0ACONTROL_PLANE_IPS%3D%2210.0.0.7%2010.0.0.8%22%0Afor%20host%20in%20%24%7BCONTROL_PLANE_IPS%7D%3B%20do%0A%20%20%20%20scp%20/etc/kubernetes/pki/ca.crt%20%22%24%7BUSER%7D%22@%24host%3A%0A%20%20%20%20scp%20/etc/kubernetes/pki/ca.key%20%22%24%7BUSER%7D%22@%24host%3A%0A%20%20%20%20scp%20/etc/kubernetes/pki/sa.key%20%22%24%7BUSER%7D%22@%24host%3A%0A%20%20%20%20scp%20/etc/kubernetes/pki/sa.pub%20%22%24%7BUSER%7D%22@%24host%3A%0A%20%20%20%20scp%20/etc/kubernetes/pki/front-proxy-ca.crt%20%22%24%7BUSER%7D%22@%24host%3A%0A%20%20%20%20scp%20/etc/kubernetes/pki/front-proxy-ca.key%20%22%24%7BUSER%7D%22@%24host%3A%0A%20%20%20%20scp%20/etc/kubernetes/pki/etcd/ca.crt%20%22%24%7BUSER%7D%22@%24host%3Aetcd-ca.crt%0A%20%20%20%20scp%20/etc/kubernetes/pki/etcd/ca.key%20%22%24%7BUSER%7D%22@%24host%3Aetcd-ca.key%0A%20%20%20%20scp%20/etc/kubernetes/admin.conf%20%22%24%7BUSER%7D%22@%24host%3A%0Adone%0A%0A%23%20%u518D%u5C07%u88AB%u52A0%u5165%20master%20%u6191%u8B49%u6B78%u4F4D%0A%09USER%3Dubuntu%20%23%20customizable%0A%09mkdir%20-p%20/etc/kubernetes/pki/etcd%0A%09mv%20/home/%24%7BUSER%7D/ca.crt%20/etc/kubernetes/pki/%0A%09mv%20/home/%24%7BUSER%7D/ca.key%20/etc/kubernetes/pki/%0A%09mv%20/home/%24%7BUSER%7D/sa.pub%20/etc/kubernetes/pki/%0A%09mv%20/home/%24%7BUSER%7D/sa.key%20/etc/kubernetes/pki/%0A%09mv%20/home/%24%7BUSER%7D/front-proxy-ca.crt%20/etc/kubernetes/pki/%0A%09mv%20/home/%24%7BUSER%7D/front-proxy-ca.key%20/etc/kubernetes/pki/%0A%09mv%20/home/%24%7BUSER%7D/etcd-ca.crt%20/etc/kubernetes/pki/etcd/ca.crt%0A%09mv%20/home/%24%7BUSER%7D/etcd-ca.key%20/etc/kubernetes/pki/etcd/ca.key%0A%09mv%20/home/%24%7BUSER%7D/admin.conf%20/etc/kubernetes/admin.conf%0A%60%60%60%0A*%20%u5982%u679C%u9700%u8981%u62D6%u5230%u8DF3%u677F%uFF0C%u518D%u5F9E%u8DF3%u677F%u8F49%u767C%20...%uFF01%uFF20%uFF04%uFF05%uFF01%uFF03%uFF04%u3113%0A%60%60%60bash%0A%23%20%u5148%u5F9E%20master%20%u6A5F%u5668%u5230%u4F7F%u7528%u8005%u5BB6%u76EE%u9304%0A%20%20%20%20cp%20/etc/kubernetes/pki/ca.crt%20cert/.%0A%20%20%20%20cp%20/etc/kubernetes/pki/ca.key%20cert/.%0A%20%20%20%20cp%20/etc/kubernetes/pki/sa.key%20cert/.%0A%20%20%20%20cp%20/etc/kubernetes/pki/sa.pub%20cert/.%0A%20%20%20%20cp%20/etc/kubernetes/pki/front-proxy-ca.crt%20cert/.%0A%20%20%20%20cp%20/etc/kubernetes/pki/front-proxy-ca.key%20cert/.%0A%20%20%20%20cp%20/etc/kubernetes/pki/etcd/ca.crt%20cert/etcd-ca.crt%0A%20%20%20%20cp%20/etc/kubernetes/pki/etcd/ca.key%20cert/etcd-ca.key%0A%20%20%20%20cp%20/etc/kubernetes/admin.conf%20cert/.%0A%20%20%20%20%0A%23%20%u518D%u5F9E%u5BB6%u76EE%u9304%u8907%u88FD%u51FA%u4F86%u5230%u8DF3%u677F%0A%20%20%20%20scp%20-r%20%7Baccount%7D@%7Bhost%7D%3Acert%20.%0A%0A%23%20%u518D%u5F9E%u8DF3%u677F%u8F49%u767C%u5230%u5176%u4ED6%u9700%u8981%u52A0%u5165%20master%20%u7684%u6A5F%u5668%0A%20%20%20%20scp%20-r%20cert%20%7Baccount%7D@%7Bhost%7D%3A%0A%0A%23%20%u628A%u88AB%u52A0%u5165%20master%20%u6A5F%u5668%u7684%u6191%u8B49%u6B78%u4F4D%0A%20%20%20%20mkdir%20-p%20/etc/kubernetes/pki/etcd%0A%20%20%20%20cp%20cert/ca.crt%20/etc/kubernetes/pki/ca.crt%0A%20%20%20%20cp%20cert/ca.key%20/etc/kubernetes/pki/ca.key%0A%20%20%20%20cp%20cert/sa.key%20/etc/kubernetes/pki/sa.key%0A%20%20%20%20cp%20cert/sa.pub%20/etc/kubernetes/pki/sa.pub%0A%20%20%20%20cp%20cert/front-proxy-ca.crt%20/etc/kubernetes/pki/front-proxy-ca.crt%0A%20%20%20%20cp%20cert/front-proxy-ca.key%20/etc/kubernetes/pki/front-proxy-ca.key%0A%20%20%20%20cp%20cert/etcd-ca.crt%20/etc/kubernetes/pki/etcd/ca.crt%0A%20%20%20%20cp%20cert/etcd-ca.key%20/etc/kubernetes/pki/etcd/ca.key%0A%20%20%20%20cp%20cert/admin.conf%20/etc/kubernetes/admin.conf%0A%0A%60%60%60%0A%0A%23%23%23%23%20%u52A0%u5165%20master%20%u6307%u4EE4%0A%60%60%60bash%0A%23%20%u4F7F%u7528%u7B2C%u4E00%u6B21%u5B89%u88DD%20kubeadm%20init%20%u6642%uFF0C%u63D0%u793A%u7684%20output%0A%23%20kubeadm%20join%20%7BmasterIP%7D%3A6443%20--token%20d7fa07.i8ch5pfl2pldr624%20--discovery-token-ca-cert-hash%20sha256%3A7860ad569cab30f4ea865a4b520c0a39cfe931815c23c498efa7fe40e0c75737%20--experimental-control-plane%0A%0A%23%20%u662F%20master%20%u5C31%u52A0%u5165%20--experimental-control-plane%0Akubeadm%20join%20%7BmasterIP%7D%3A6443%20--token%20d7fa07.i8ch5pfl2pldr624%20--discovery-token-ca-cert-hash%20sha256%3A7860ad569cab30f4ea865a4b520c0a39cfe931815c23c498efa7fe40e0c75737%20--experimental-control-plane%0A%0A%23%20%u662F%20woker%20%u53EA%u9700%u8981%0Akubeadm%20join%20%7BmasterIP%7D%3A6443%20--token%20d7fa07.i8ch5pfl2pldr624%20--discovery-token-ca-cert-hash%20sha256%3A7860ad569cab30f4ea865a4b520c0a39cfe931815c23c498efa7fe40e0c75737%0A%0A%23%20%u7136%u5F8C%u8A2D%u5B9A%u4E0A%20worker%20%u6A19%u7C64%0Akubectl%20label%20node%20%7BNODENAME%7D%20node-role.kubernetes.io/worker%3Dworker%0A%60%60%60%0A%23%23%23%23%20%u4EE5%20canal%20%u70BA%u4F8B%3A%0A%u9700%u8981%u524D%u7F6E%20--pod-network-cidr%3D10.244.0.0/16%20%u548C%20amd64%20%u7684%u6A5F%u5668%0A%60%60%60bash%0A%0A%23%20%u5B89%u88DD%u7DB2%u8DEF%0Akubectl%20apply%20-f%20https%3A//docs.projectcalico.org/v3.3/getting-started/kubernetes/installation/hosted/canal/rbac.yaml%0Akubectl%20apply%20-f%20https%3A//docs.projectcalico.org/v3.3/getting-started/kubernetes/installation/hosted/canal/canal.yaml%0A%0A%60%60%60%0A%0A%23%20DONE.%0A%0A%0A%u53C3%u8003%u9023%u7D50%uFF1A%0A*%20%5BInstalling%20kubeadm%5D%28https%3A//kubernetes.io/docs/setup/independent/create-cluster-kubeadm/%29%0A*%20%5BCreating%20a%20single%20master%20cluster%20with%20kubeadm%5D%28https%3A//kubernetes.io/docs/setup/independent/install-kubeadm/%23check-required-ports%29%0A*%20%5BCreating%20Highly%20Available%20Clusters%20with%20kubeadm%5D%28https%3A//kubernetes.io/docs/setup/independent/high-availability/%29%0A%0A</center><br/></body></html>