<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content="Evernote Mac 7.8 (457454)"/><meta name="created" content="2019-03-13 10:02:56 +0000"/><meta name="source" content="maxiang"/><meta name="source-application" content="maxiang"/><meta name="updated" content="2019-03-13 10:07:32 +0000"/><title>新增 Kubernetes ClusterUser Admin  方法</title></head><body lang="v2" style="color: #2c3f51; font-family: 'Helvetica Neue', Arial, 'Hiragino Sans GB', STHeiti, 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, Song, sans-serif; line-height: 1.6; background: none;"><del style="position:relative;display:block;z-index:10;"><a style="position: absolute;color: #FFF;text-decoration: none;font-size: 12px;height: 25px;border-radius: 0;margin-top: -20px;right: 15px;background: rgba(0, 0, 0, 0);border-left: 10px solid #BB3A34;border-right: 10px solid #BB3A34;border-bottom: 5px solid rgba(0, 0, 0, 0);width: 0;text-indent:-100000px;" href="http://marxi.co/#/?provider=evernote_int&amp;guid=9f72d8e2-c2f9-4a99-bd09-611d0c693bab&amp;notebook=%E5%B7%A5%E4%BD%9C%E7%A2%8E%E7%89%87">Edit</a></del><div style="color: #2c3f51; font-family: 'Helvetica Neue', Arial, 'Hiragino Sans GB', STHeiti, 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, Song, sans-serif; line-height: 1.6;">
                        
                    



<h1 style="font-size: 41.6px; margin: 1.2em 0 .6em 0; font-family: inherit; font-weight: bold; line-height: 1.1; color: inherit; margin-top: 21px; margin-bottom: 10.5px; text-align: start;">新增 Kubernetes ClusterUser Admin  方法</h1>



<h4 style="font-family: inherit; font-weight: bold; color: inherit; margin-top: 10.5px; margin-bottom: 10.5px; font-size: 20px; margin: 1.2em 0 .6em 0; text-align: start; line-height: 1.6;">設定 cluster</h4>

<pre style="font-family: 'Source Code Pro',Consolas,monospace; white-space: pre-wrap; display: block; background-color: rgba(102,128,153,0.05); color: #333; word-wrap: break-word; font-size: .9em; background: #f6f6f6; line-height: 1.6; margin: 0 0 1.1em; padding: 0; border: 0; border-radius: 5px; text-align: start; word-break: break-all;"><code style="font-family: 'Source Code Pro',Consolas,monospace; font-size: inherit; background-color: transparent; white-space: pre-wrap; border-radius: 0; color: #f8f8f2; display: block; overflow-x: auto; background: #23241f; padding: 1.3em 2em;"><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><span style="display: inline; line-height: 1.6; color: #75715e; background-color: transparent;"># 指定集群</span>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">kubectl config <span style="display: inline; line-height: 1.6; color: #e6db74; background-color: transparent;">set</span>-cluster {clusterName} --server=https://{yourIP}
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><span style="display: inline; line-height: 1.6; color: #75715e; background-color: transparent;"># 關閉 cert 檢查</span>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">kubectl config <span style="display: inline; line-height: 1.6; color: #e6db74; background-color: transparent;">set</span>-cluster {clusterName} --insecure-skip-tls-verify=<span style="display: inline; line-height: 1.6; color: #ae81ff; background-color: transparent;">true</span>
</div></code></pre>

<h4 style="font-family: inherit; font-weight: bold; color: inherit; margin-top: 10.5px; margin-bottom: 10.5px; font-size: 20px; margin: 1.2em 0 .6em 0; text-align: start; line-height: 1.6;">建立用戶 Credentials</h4>

<p style="margin: 0 0 1.1em; line-height: 1.6;">使用如下步驟產生：</p>

<ul style="margin-top: 0; margin-bottom: 1.1em; padding-left: 2em; line-height: 1.6;"><li style="line-height: 1.6;"><p style="margin: 0; line-height: 1.6;">*.key</p></li>
<li style="line-height: 1.6;"><p style="margin: 0; line-height: 1.6;">*.csr</p></li>
<li style="line-height: 1.6;"><p style="margin: 0; line-height: 1.6;">*.crt</p></li>
</ul>



<pre style="font-family: 'Source Code Pro',Consolas,monospace; white-space: pre-wrap; display: block; background-color: rgba(102,128,153,0.05); color: #333; word-wrap: break-word; font-size: .9em; background: #f6f6f6; line-height: 1.6; margin: 0 0 1.1em; padding: 0; border: 0; border-radius: 5px; text-align: start; word-break: break-all;"><code style="font-family: 'Source Code Pro',Consolas,monospace; font-size: inherit; background-color: transparent; white-space: pre-wrap; border-radius: 0; color: #f8f8f2; display: block; overflow-x: auto; background: #23241f; padding: 1.3em 2em;"><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><span style="display: inline; line-height: 1.6; color: #75715e; background-color: transparent;"># 產生：*.key</span>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">openssl genrsa -out {name}.key 2048
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><div style="line-height: 1.6;"/>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><span style="display: inline; line-height: 1.6; color: #75715e; background-color: transparent;"># 產生：*.csr</span>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">openssl req -new -key {name}.key -out {name}.csr -subj <span style="display: inline; line-height: 1.6; color: #e6db74; background-color: transparent;">"/CN={name}/O={group}"</span>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><div style="line-height: 1.6;"/>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><span style="display: inline; line-height: 1.6; color: #75715e; background-color: transparent;"># 需要使用 Kubernetes Master 內的憑證簽名，預設路徑一般為 /etc/kubernetes/pki 內。</span>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><span style="display: inline; line-height: 1.6; color: #75715e; background-color: transparent;"># 產生：*.crt</span>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">openssl x509 -req -in  {name}.csr -CA {CA_LOCATION}/ca.crt -CAkey {CA_LOCATION}/ca.key -CAcreateserial -out {name}.crt -days 500
</div></code></pre>

<p style="margin: 0 0 1.1em; line-height: 1.6;">完成後產生這些檔案放到指定位置，再使用下面步驟指定證書和使用者。</p>

<pre style="font-family: 'Source Code Pro',Consolas,monospace; white-space: pre-wrap; display: block; background-color: rgba(102,128,153,0.05); color: #333; word-wrap: break-word; font-size: .9em; background: #f6f6f6; line-height: 1.6; margin: 0 0 1.1em; padding: 0; border: 0; border-radius: 5px; text-align: start; word-break: break-all;"><code style="font-family: 'Source Code Pro',Consolas,monospace; font-size: inherit; background-color: transparent; white-space: pre-wrap; border-radius: 0; color: #f8f8f2; display: block; overflow-x: auto; background: #23241f; padding: 1.3em 2em;"><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><span style="display: inline; line-height: 1.6; color: #75715e; background-color: transparent;"># 指定證書位置</span>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">kubectl config <span style="display: inline; line-height: 1.6; color: #e6db74; background-color: transparent;">set</span>-credentials {name} --client-certificate=/home/{name}/.certs/{name}.crt  --client-key=/home/{name}/.certs/{name}.key
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><div style="line-height: 1.6;"/>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><span style="display: inline; line-height: 1.6; color: #75715e; background-color: transparent;"># 命名 context、指定集群、命名空間、使用者</span>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">kubectl config <span style="display: inline; line-height: 1.6; color: #e6db74; background-color: transparent;">set</span>-context {contextName} --cluster={clusterName} --namespace={namespace} --user={user}
</div></code></pre>



<h4 style="font-family: inherit; font-weight: bold; color: inherit; margin-top: 10.5px; margin-bottom: 10.5px; font-size: 20px; margin: 1.2em 0 .6em 0; text-align: start; line-height: 1.6;">建立 ClusterRoleBinding</h4>

<p style="margin: 0 0 1.1em; line-height: 1.6;">到 master 設定 ClusterRoleBinding</p>

<pre style="font-family: 'Source Code Pro',Consolas,monospace; white-space: pre-wrap; display: block; background-color: rgba(102,128,153,0.05); color: #333; word-wrap: break-word; font-size: .9em; background: #f6f6f6; line-height: 1.6; margin: 0 0 1.1em; padding: 0; border: 0; border-radius: 5px; text-align: start; word-break: break-all;"><code style="font-family: 'Source Code Pro',Consolas,monospace; font-size: inherit; background-color: transparent; white-space: pre-wrap; border-radius: 0; color: #f8f8f2; display: block; overflow-x: auto; background: #23241f; padding: 1.3em 2em;"><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><span style="display: inline; line-height: 1.6; color: #75715e; background-color: transparent;"># 此範例為最大權限使用、直接使用預設的 cluster-admin 做 binding</span>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><span style="display: inline; line-height: 1.6; color: #f92672; background-color: transparent;">apiVersion:</span> <span style="display: inline; line-height: 1.6; color: #e6db74; background-color: transparent;">rbac.authorization.k8s.io/v1</span>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><span style="display: inline; line-height: 1.6; color: #f92672; background-color: transparent;">kind:</span> <span style="display: inline; line-height: 1.6; color: #e6db74; background-color: transparent;">ClusterRoleBinding</span>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><span style="display: inline; line-height: 1.6; color: #f92672; background-color: transparent;">metadata:</span>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><span style="display: inline; line-height: 1.6; color: #f92672; background-color: transparent;">  annotations:</span>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;">    <span style="display: inline; line-height: 1.6; color: #e6db74; background-color: transparent;">rbac.authorization.kubernetes.io/autoupdate:</span> <span style="display: inline; line-height: 1.6; color: #e6db74; background-color: transparent;">"true"</span>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><span style="display: inline; line-height: 1.6; color: #f92672; background-color: transparent;">  name:</span> <span style="display: inline; line-height: 1.6; color: #e6db74; background-color: transparent;">cluster-sun</span>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><span style="display: inline; line-height: 1.6; color: #f92672; background-color: transparent;">roleRef:</span>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><span style="display: inline; line-height: 1.6; color: #f92672; background-color: transparent;">  apiGroup:</span> <span style="display: inline; line-height: 1.6; color: #e6db74; background-color: transparent;">rbac.authorization.k8s.io</span>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><span style="display: inline; line-height: 1.6; color: #f92672; background-color: transparent;">  kind:</span> <span style="display: inline; line-height: 1.6; color: #e6db74; background-color: transparent;">ClusterRole</span>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><span style="display: inline; line-height: 1.6; color: #f92672; background-color: transparent;">  name:</span> <span style="display: inline; line-height: 1.6; color: #e6db74; background-color: transparent;">cluster-admin</span>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><span style="display: inline; line-height: 1.6; color: #f92672; background-color: transparent;">subjects:</span>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><span style="display: inline; line-height: 1.6; color: #f92672; background-color: transparent;">- apiGroup:</span> <span style="display: inline; line-height: 1.6; color: #e6db74; background-color: transparent;">rbac.authorization.k8s.io</span>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><span style="display: inline; line-height: 1.6; color: #f92672; background-color: transparent;">  kind:</span> <span style="display: inline; line-height: 1.6; color: #e6db74; background-color: transparent;">User</span>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><span style="display: inline; line-height: 1.6; color: #f92672; background-color: transparent;">  name:</span> <span style="display: inline; line-height: 1.6; color: #e6db74; background-color: transparent;">sun</span>
</div><div style="min-height: 1.5em; color: inherit; line-height: 1.6; background-color: transparent;"><div style="line-height: 1.6;"/>
</div></code></pre>



<h1 style="font-size: 41.6px; margin: 1.2em 0 .6em 0; font-family: inherit; font-weight: bold; line-height: 1.1; color: inherit; margin-top: 21px; margin-bottom: 10.5px; text-align: start;">Done</h1>

<h4 style="font-family: inherit; font-weight: bold; color: inherit; margin-top: 10.5px; margin-bottom: 10.5px; font-size: 20px; margin: 1.2em 0 .6em 0; text-align: start; line-height: 1.6;">參考連結：</h4>

<ul style="margin-top: 0; margin-bottom: 1.1em; padding-left: 2em; line-height: 1.6;"><li style="line-height: 1.6;"><p style="margin: 0; line-height: 1.6;"><a href="https://docs.bitnami.com/kubernetes/how-to/configure-rbac-in-your-kubernetes-cluster/#use-case-1-create-user-with-limited-namespace-access" target="_blank" style="background: transparent; color: #1980e6; text-decoration: none;">Configure RBAC In Your Kubernetes Cluster</a></p></li>
<li style="line-height: 1.6;"><p style="margin: 0; line-height: 1.6;"><a href="https://kubernetes.io/docs/reference/access-authn-authz/authentication/" target="_blank" style="background: transparent; color: #1980e6; text-decoration: none;">Authentication</a></p></li>
</ul></div><center style="display:none !important;visibility:collapse !important;height:0 !important;white-space:nowrap;width:100%;overflow:hidden">%23%20%u65B0%u589E%20Kubernetes%20ClusterUser%20Admin%20%20%u65B9%u6CD5%0A%0A%23%23%23%23%20%u8A2D%u5B9A%20cluster%0A%60%60%60bash%0A%23%20%u6307%u5B9A%u96C6%u7FA4%0Akubectl%20config%20set-cluster%20%7BclusterName%7D%20--server%3Dhttps%3A//%7ByourIP%7D%0A%23%20%u95DC%u9589%20cert%20%u6AA2%u67E5%0Akubectl%20config%20set-cluster%20%7BclusterName%7D%20--insecure-skip-tls-verify%3Dtrue%0A%60%60%60%0A%0A%23%23%23%23%20%u5EFA%u7ACB%u7528%u6236%20Credentials%0A%u4F7F%u7528%u5982%u4E0B%u6B65%u9A5F%u7522%u751F%uFF1A%0A*%20*.key%0A*%20*.csr%0A*%20*.crt%0A%60%60%60bash%0A%23%20%u7522%u751F%uFF1A*.key%0Aopenssl%20genrsa%20-out%20%7Bname%7D.key%202048%0A%0A%23%20%u7522%u751F%uFF1A*.csr%0Aopenssl%20req%20-new%20-key%20%7Bname%7D.key%20-out%20%7Bname%7D.csr%20-subj%20%22/CN%3D%7Bname%7D/O%3D%7Bgroup%7D%22%0A%0A%23%20%u9700%u8981%u4F7F%u7528%20Kubernetes%20Master%20%u5167%u7684%u6191%u8B49%u7C3D%u540D%uFF0C%u9810%u8A2D%u8DEF%u5F91%u4E00%u822C%u70BA%20/etc/kubernetes/pki%20%u5167%u3002%0A%23%20%u7522%u751F%uFF1A*.crt%0Aopenssl%20x509%20-req%20-in%20%20%7Bname%7D.csr%20-CA%20%7BCA_LOCATION%7D/ca.crt%20-CAkey%20%7BCA_LOCATION%7D/ca.key%20-CAcreateserial%20-out%20%7Bname%7D.crt%20-days%20500%0A%60%60%60%0A%0A%u5B8C%u6210%u5F8C%u7522%u751F%u9019%u4E9B%u6A94%u6848%u653E%u5230%u6307%u5B9A%u4F4D%u7F6E%uFF0C%u518D%u4F7F%u7528%u4E0B%u9762%u6B65%u9A5F%u6307%u5B9A%u8B49%u66F8%u548C%u4F7F%u7528%u8005%u3002%0A%60%60%60bash%0A%23%20%u6307%u5B9A%u8B49%u66F8%u4F4D%u7F6E%0Akubectl%20config%20set-credentials%20%7Bname%7D%20--client-certificate%3D/home/%7Bname%7D/.certs/%7Bname%7D.crt%20%20--client-key%3D/home/%7Bname%7D/.certs/%7Bname%7D.key%0A%0A%23%20%u547D%u540D%20context%u3001%u6307%u5B9A%u96C6%u7FA4%u3001%u547D%u540D%u7A7A%u9593%u3001%u4F7F%u7528%u8005%0Akubectl%20config%20set-context%20%7BcontextName%7D%20--cluster%3D%7BclusterName%7D%20--namespace%3D%7Bnamespace%7D%20--user%3D%7Buser%7D%0A%60%60%60%0A%0A%23%23%23%23%20%u5EFA%u7ACB%20ClusterRoleBinding%0A%u5230%20master%20%u8A2D%u5B9A%20ClusterRoleBinding%0A%60%60%60yaml%0A%23%20%u6B64%u7BC4%u4F8B%u70BA%u6700%u5927%u6B0A%u9650%u4F7F%u7528%u3001%u76F4%u63A5%u4F7F%u7528%u9810%u8A2D%u7684%20cluster-admin%20%u505A%20binding%0AapiVersion%3A%20rbac.authorization.k8s.io/v1%0Akind%3A%20ClusterRoleBinding%0Ametadata%3A%0A%20%20annotations%3A%0A%20%20%20%20rbac.authorization.kubernetes.io/autoupdate%3A%20%22true%22%0A%20%20name%3A%20cluster-sun%0AroleRef%3A%0A%20%20apiGroup%3A%20rbac.authorization.k8s.io%0A%20%20kind%3A%20ClusterRole%0A%20%20name%3A%20cluster-admin%0Asubjects%3A%0A-%20apiGroup%3A%20rbac.authorization.k8s.io%0A%20%20kind%3A%20User%0A%20%20name%3A%20sun%0A%0A%60%60%60%0A%0A%23%20Done%0A%0A%23%23%23%23%20%u53C3%u8003%u9023%u7D50%uFF1A%0A*%20%5BConfigure%20RBAC%20In%20Your%20Kubernetes%20Cluster%5D%28https%3A//docs.bitnami.com/kubernetes/how-to/configure-rbac-in-your-kubernetes-cluster/%23use-case-1-create-user-with-limited-namespace-access%29%0A*%20%5BAuthentication%5D%28https%3A//kubernetes.io/docs/reference/access-authn-authz/authentication/%29</center><br/></body></html>